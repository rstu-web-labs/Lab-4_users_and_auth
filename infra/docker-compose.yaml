version: '3.9'

services:  
  postgres_db:
    container_name: pglab4
    image: postgres:16.1
    environment:
      env_file: ./.env
      POSTGRES_DB: ${db_postgres_name}
      POSTGRES_USER: ${db_postgres_username}
      POSTGRES_PASSWORD: ${db_postgres_password}
    ports:
      - "5432:5432"
    networks:
      - mynetwork

  rabbitmq:
    container_name: rmlab4
    image: rabbitmq:3.13.2-management-alpine
    ports:
      - "15672:15672" 
    environment:
      env_file: ./.env
      RABBITMQ_DEFAULT_USER: ${mq_user} 
      RABBITMQ_DEFAULT_PASS: ${mq_pass}
    networks:
      - mynetwork

  celery:
    container_name: cllab4
    image: mtsygikalo/lab4
    command: celery -A app.email_task.task worker --loglevel=info
    networks:
      - mynetwork
    depends_on:
      - rabbitmq

  app:
    container_name: applab4
    image: mtsygikalo/lab4
    command: sh -c "alembic upgrade head && python3.11 -m app.main"
    ports:
     - 8080:8000
    networks:
      - mynetwork
    depends_on:
      - postgres_db
      - celery

networks:
  mynetwork:
    driver: bridge